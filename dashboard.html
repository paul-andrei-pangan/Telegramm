<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Chat Dashboard</title>
  <link rel="stylesheet" href="css/dstyle.css">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
</head>
<body>

  <div class="sidebar">
    <h2 id="userFullName">Users</h2>
    <input type="text" id="searchInput" placeholder="Search user..." oninput="searchUser()" class="search-bar" />
    <ul id="userList" class="menu">
      <li>
        <span onclick="viewProfile()">My Profile</span>
        <img src="img/" alt="Profile Picture">
      </li>
      <li>
        <span onclick="viewContact()">Contact</span>
        <img src="contact.jpg" alt="Contact Icon">
      </li>
      <li>
        <span onclick="viewCallsHistory()">Calls History</span>
        <img src="calls.jpg" alt="Calls Icon">
      </li>
      <li>
        <span onclick="viewAbout()">About</span>
        <img src="about.jpg" alt="About Icon">
      </li>
      <li>
        <span onclick="logout()">Logout</span>
        <img src="logout.jpg" alt="Logout Icon">
      </li>
    </ul>
  </div>

  <div class="dashboard-container">
    <div class="main-content">
      <!-- Centered Title -->
      <h1 class="centered-title">TeleGanda</h1>

      <!-- Chat Box -->
      <div id="chatBox" class="chat-window" style="display: none;">
        <div class="chat-header">
          <h3 id="chatWith">Chat</h3>
          <button class="close-chat" onclick="closeChatBox()">✖</button>
        </div>
        <div id="chatHistory" class="chat-history"></div>
        <div class="chat-input-container">
          <input type="text" id="chatInput" class="chat-input" placeholder="Type your message here..." disabled />
          <button onclick="sendMessage()" class="send-button" disabled>Send</button>
        </div>
      </div>
    </div>
  </div>

  <div class="header">
    <span class="menu-btn" onclick="toggleMenu()">☰</span>
    <ul class="menu">
      <li onclick="viewProfile()">My Profile</li>
      <li onclick="viewContact()">Contact</li>
      <li onclick="viewCallsHistory()">Calls History</li>
      <li onclick="viewAbout()">About</li>
    </ul>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const chatHistoryElement = document.getElementById("chatHistory");
    const chatInput = document.getElementById("chatInput");
    const sendButton = document.querySelector(".send-button");
    const userListElement = document.getElementById("userList");
    const chatWithHeader = document.getElementById("chatWith");
    const searchInput = document.getElementById("searchInput");
    const userFullNameElement = document.getElementById("userFullName");
    
    let activeUser = null; 
    const loggedInUser = localStorage.getItem("loggedInUser");
    const registeredUsers = JSON.parse(localStorage.getItem("registeredUsers")) || [];

    const loggedInUserInfo = registeredUsers.find(user => user.username === loggedInUser);
    const loggedInUserFullName = loggedInUserInfo ? loggedInUserInfo.fullName : "User";

    userFullNameElement.textContent = loggedInUserFullName;

    const availableUsers = registeredUsers.filter(user => user.username !== loggedInUser);
    populateUserList(availableUsers.map(user => user.username));

    function populateUserList(users) {
      userListElement.innerHTML = "";
      users.forEach(user => {
        const li = document.createElement("li");
        li.textContent = user;
        li.className = "user-item";
        li.onclick = () => selectUser(user);
        userListElement.appendChild(li);
      });
    }

    function searchUser() {
      const query = searchInput.value.toLowerCase();
      const filteredUsers = availableUsers
        .map(user => user.username)
        .filter(username => username.toLowerCase().includes(query));

      populateUserList(filteredUsers);

      if (filteredUsers.length === 0) {
        userListElement.innerHTML = "<li class='no-user'>No user found</li>";
      }
    }

    function selectUser(user) {
      activeUser = user;

      // Fetch the full name of the selected user
      const selectedUserInfo = registeredUsers.find(userInfo => userInfo.username === activeUser);
      const fullName = selectedUserInfo ? selectedUserInfo.fullName : "User";

      // Show chat box and update header
      chatBox.style.display = "block";
      chatWithHeader.textContent = `Chat with ${fullName}`; // Display full name

      // Enable input and send button
      chatInput.disabled = false;
      sendButton.disabled = false;

      // Load chat history for the selected user
      loadChatHistory(user);
    }

    function loadChatHistory(user) {
      chatHistoryElement.innerHTML = "";
      const chatKey = getChatKey(loggedInUser, user);
      const chatMessages = JSON.parse(localStorage.getItem(chatKey)) || [];

      chatMessages.forEach(message => {
        const chatBubble = document.createElement("div");
        chatBubble.className = message.sender === loggedInUser ? "chat-bubble me" : "chat-bubble";
        chatBubble.textContent = message.text;
        chatHistoryElement.appendChild(chatBubble);
      });

      chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
    }

    function sendMessage() {
      const messageText = chatInput.value.trim();
      if (messageText && activeUser) {
        const chatKey = getChatKey(loggedInUser, activeUser);
        const chatMessages = JSON.parse(localStorage.getItem(chatKey)) || [];

        const newMessage = { sender: loggedInUser, text: messageText };
        chatMessages.push(newMessage);
        localStorage.setItem(chatKey, JSON.stringify(chatMessages));

        const chatBubble = document.createElement("div");
        chatBubble.className = "chat-bubble me";
        chatBubble.textContent = messageText;
        chatHistoryElement.appendChild(chatBubble);

        chatInput.value = "";
        chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
      }
    }

    function getChatKey(user1, user2) {
      return [user1, user2].sort().join("_");
    }

    function closeChatBox() {
      chatBox.style.display = "none";
      chatInput.disabled = true;
      sendButton.disabled = true;
      chatWithHeader.textContent = "Chat";
    }

    function toggleMenu() {
      const menu = document.querySelector(".header .menu");
      menu.classList.toggle("show");
    }

    function viewProfile() {
      alert("View Profile clicked");
    }

    function viewContact() {
      alert("Contact clicked");
    }

    function viewCallsHistory() {
      alert("Calls History clicked");
    }

    function viewAbout() {
      alert("About clicked");
    }

    function logout() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
